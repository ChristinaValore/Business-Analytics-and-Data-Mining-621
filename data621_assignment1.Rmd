---
title: 'Assignment 1: Data 621'
author: "Critical Thinking Group 5 - Christina Valore, Henry Vasquez, Chunhui Zhu, Chunmei Zhu"
date: "9/16/2019"
output: html_document
---

```{r,message=F, warning=F}
library(tidyverse); library(dplyr); library(psych); library(corrplot); library (ggplot2); library(funModeling) 
```

## Money Ball

In this homework assignment, you will explore, analyze and model a data set containing approximately 2200 records. Each record represents a professional baseball team from the years 1871 to 2006 inclusive. Each record has the performance of the team for the given year, with all of the statistics adjusted to match the performance of a 162 game season.

Your objective is to build a multiple linear regression model on the training data to predict the number of wins for the team. You can only use the variables given to you (or variables that you derive from the variables provided). Below is a short description of the variables of interest in the data set:

Response variable: Target_Wins
Predictor variable(s): Target_Wins = (team batting base hits + team batting walks) - (team pitching hits allowed + team pitching walks allowed)

### Data Analysis

First, we import data from our GitHub repo, then we remove any unnecessary columns such as 'index', which plays no role in our analysis. Once completed, we view the top of each dataset to ensure data was imported in the correct format.

```{r }
# import data
train <-read.csv("https://raw.githubusercontent.com/ChristinaValore/Business-Analytics-and-Data-Mining-621/master/moneyball-training-data.csv") 
eval <-read.csv("https://raw.githubusercontent.com/ChristinaValore/Business-Analytics-and-Data-Mining-621/master/moneyball-evaluation-data.csv") 

train <- select(train,-1) # remove index column, which is first column in both datasets
eval <- select(eval,-1)

head (train) # view data for both sets, notice the index column has been removed
head (eval)

```

### Statistics

The summary function reveals there are a considerable amount of NA's and some variables have a min of 0, which can be possible in baseball, however a variable with too many zeros will be unuseful. Additonally some variables have max values that look far off from the 3rd quartile, i.e. team_batting_3B has the 3rd q at 72, while max is 223. These could be possible outliers.

```{r}
summary(train) # univariate view of basic stats
```


### Zeros and NA values

Using the df_status function from the funModeling package, we see that the quantity of zeros (q_zeros) is quite low for all variables. This can be confirmed by percentage of zeros (p_zeros) as all fall below 1%. 

The NA values seem to be more discerning as several of the variable have high percentage NA's. Specifically the values, baserun_CS and batting_HBP which has 33.92% and 91.61% NA's respectively. 

```{r}
#gives us information about 0's, NA's, variable type, and unique values
df_status(train)
```

These variables will need to be excluded from our analysis as we only want variables with less than 20% NA's. 

```{r}
train <- subset(train, select = -c(TEAM_BASERUN_CS,TEAM_BATTING_HBP)) # drop both variable columns from data frame
head(train) # check columns are removed
```


### Graphs

After some research, we decide to investigate the hits, walks and hits allowed and walks allowed as we think these four variables overall will have an impact on the wins.

By examining the scatter plots, we see that team batting base hits and team batting walks seem to have a linear relationship to wins as those variables increase it looks as if wins increase as well. 

Team pitching hits allowed and team pitching walks allowed, are not as clear and may not have a linear relationship to wins. They both also look to have more extreme ouliers as we saw in the summary. 

```{r}
par(mfrow = c(2,2)) #view graphs in 2x2 view

plot(TARGET_WINS ~ TEAM_BATTING_H,train) # batting hits

plot(TARGET_WINS ~ TEAM_BATTING_BB,train) # batting walks

plot(TARGET_WINS ~ TEAM_PITCHING_H,train) # pitching hits allowed

plot(TARGET_WINS ~ TEAM_PITCHING_BB,train) # pitching walks allowed

```

Batting_H and Batting_BB look to be the most normally distributed, where pitching_H and pitching_BB seem to be more concetrated to the left again indicating there may not be a linear relationship to target wins. 

```{r}

par(mfrow = c(2,2)) #view graphs in 2x2 view

hist(train$TEAM_BATTING_H) # hits 

hist(train$TEAM_BATTING_BB) # walks

hist(train$TEAM_PITCHING_H) # hits allowed

hist(train$TEAM_PITCHING_BB) #walks allowed

```

### Outliers

Since this will be a multi-variable regression, we want to consider how all four variables will affect the wins. This is done by using Cook's distance, which calculates the influence each point (row) has on the predicted outcome. 

```{r}
m <- lm(TARGET_WINS ~ TEAM_BATTING_H + TEAM_BATTING_BB + TEAM_PITCHING_H + TEAM_PITCHING_BB, data=train) # model with four variables considered

cook <- cooks.distance(m)

plot(cook, pch="*", cex=2, main="Cook's Distance: Influential Observations") # plot Cook's distance
abline(h = 4*mean(cook, na.rm=T), col="red") # add cutoff line, which is equivalent to 4*mean
text(x=1:length(cook)+1, y=cook, labels=ifelse(cook>4*mean(cook, na.rm=T),names(cook),""), col="red") # add labels for points (rows)
```

We have 41 rows that are influential to the predicted wins, with row 1342 being the most influential. Aside from about 4 other outliers the rest seem to be pretty close to 4*mean. 

We can see the full view of the influential numbers by adding to a dataframe and viewing the head. 

```{r}
influential <- as.numeric(names(cook)[(cook > 4*mean(cook, na.rm=T))]) # add influential rows to dataframe

head(train[influential, ]) # show rows that match influential numbers
```

For confirmation, we can use the Car package to verify most influential outlier is row 1342. In the next section, we will decide on how to handle these 41 outliers. 

```{r}
car::outlierTest(m)
```

## Data Preparation

### Add variable

Not sure how to calculate runs from the given data?
```{r}
train$RUN_DIFF = train$TEAM_BATTING_HR - train$TEAM_PITCHING_HR
```

I wanted to plot here Run diff vs Wins, however this graph looks off, there should be some runs in the positive - again I think we need an equation to calculate overal runs. 
```{r}
plot(train$RUN_DIFF, train$TARGET_WINS, xlab = "Homeruns", ylab = "Wins", title("Wins vs. homeruns"))

```

## Build Models

## Select Models

Sources: 

http://www.sthda.com/english/wiki/visualize-correlation-matrix-using-correlogram

https://kharshit.github.io/blog/2017/07/28/moneyball-how-linear-regression-changed-baseball

https://towardsdatascience.com/linear-regression-moneyball-part-1-b93b3b9f5b53

http://r-statistics.co/Outlier-Treatment-With-R.html

https://blog.datascienceheroes.com/exploratory-data-analysis-in-r-intro/

